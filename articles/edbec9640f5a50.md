---
title: "rustã§docker compose watchã‚’ä½¿ã£ã¦ã¿ã‚‹"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "actixweb", "askama", "docker", "dockercompose"]
published: true
---

# ã¯ã˜ã‚ã«
æ™®æ®µã€Rustã§é–‹ç™ºã™ã‚‹æ™‚ã«cargo watchã‚’ä½¿ã£ã¦ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã—ãªãŒã‚‰é–‹ç™ºã‚’ã—ã¦ãŠã‚Šã¾ã™ã€‚
å…ˆæ—¥ã€docker compose watchã®è¨˜äº‹ã‚’è¦‹ã‹ã‘ã¦ã€cargo watchã®ã‚ˆã†ã«ã§ãã‚‹ãªã‚‰é¢ç™½ãã†ã¨æ€ã„ã€ã“ã®è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚

@[card](https://www.docker.com/blog/announcing-docker-compose-watch-ga-release/)

åˆã‚ã›ã¦ã€å°‘ã—å‰ã«docker initã«rustãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãŸãªã®ã§ã€ã“ã¡ã‚‰ã‚‚æ°—ã«ãªã£ã¦ã„ãŸã®ã§ã€åˆã‚ã›ã¦è©¦ã—ã¦ã¿ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã‚ˆãä½¿ã£ã¦ã„ã‚‹Actix-web + askama + htmx ã‚’ä½¿ã£ãŸç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã®ä½œæˆã«ãªã‚Šã¾ã™ã€‚(htmxã¯å®Œå…¨ã«ãŠã¾ã‘)

ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã§ã™
@[card](https://github.com/fruscianteee/docker_watch_demo_with_rust)

è‰²ã€…ã€è›‡è¶³ãŒå¤šã„ã®ã§ã€çµè«–ã‹ã‚‰è¦‹ãŸã„å ´åˆã¯ã€Œdocker compose watchã®è¨­å®šã€ã‹ã‚‰è¦‹ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

# ç’°å¢ƒ
docker-desktop 4.24.2
rust 1.73.0

# å†…å®¹

## rustãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
```bash
cargo init
```

## dockerãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
```bash
docker init
```
ä»¥ä¸‹ã®é¸æŠã‚’ã—ã¾ã—ãŸã€‚
```
? What application platform does your project use? `Rust`

? What version of Rust do you want to use? `1.73.0`

? What port does your server listen on? `8080`
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚
- .dockerignore
- Dockerfile
- compose.yaml

ç·¨é›†ç®‡æ‰€ã¯[ã“ã¡ã‚‰](https://github.com/fruscianteee/docker_watch_demo_with_rust/commit/f9f1245a7d5e8b1d19dc1477d41fa78288a6e29d)ã§ã™ã€‚

(æœ€è¿‘ã¯docker-compose.yamlã§ã¯ãªãã€compose.yamlã«ãªã£ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚)

ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ã¿ã¦ã¿ã¾ã™ã€‚

### .dockerignore
ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸããªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè‡ªå‹•ã§è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã¦ã¾ã™ã€‚
è‡ªå‹•ã§ä¾¿åˆ©ã§ã™ã€‚

### Dockerfile
ä»¥ä¸‹ã®å†…å®¹ãŒç”Ÿæˆã•ã‚Œã¦ã¾ã—ãŸã€‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ç•¥ã—ã¦ã¾ã™ã€‚
```dockerfile:Dockerfile
# -----------------------------------------------
ARG RUST_VERSION=1.73.0
ARG APP_NAME=docker_watch_demo_with_rust
FROM rust:${RUST_VERSION}-slim-bullseye AS build
ARG APP_NAME
WORKDIR /app

RUN --mount=type=bind,source=src,target=src \
    --mount=type=bind,source=Cargo.toml,target=Cargo.toml \
    --mount=type=bind,source=Cargo.lock,target=Cargo.lock \
    --mount=type=cache,target=/app/target/ \
    --mount=type=cache,target=/usr/local/cargo/registry/ \
    <<EOF
set -e
cargo build --locked --release
cp ./target/release/$APP_NAME /bin/server
EOF

# -----------------------------------------------
FROM debian:bullseye-slim AS final

ARG UID=10001
RUN adduser \
    --disabled-password \
    --gecos "" \
    --home "/nonexistent" \
    --shell "/sbin/nologin" \
    --no-create-home \
    --uid "${UID}" \
    appuser
USER appuser

COPY --from=build /bin/server /bin/

EXPOSE 8080

CMD ["/bin/server"]

```

è‡ªåˆ†ã§æ›¸ã‹ãšã¨ã‚‚ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®è¨˜è¼‰ã«ãªã£ã¦ã„ã‚‹ã®ã¯ã‹ãªã‚Šä¾¿åˆ©ã§ã™ã­ã€‚
ãƒ“ãƒ«ãƒ‰ã®éƒ¨åˆ†ã§ã¯ã€`--mount=type=cache`ãªã©ã‚’ä½¿ã£ã¦é«˜é€ŸåŒ–ã‚’å›³ã£ã¦ã„ã¾ã™ã­ã€‚

imageã‚’ä½œæˆã™ã‚‹éƒ¨åˆ†ã§ã€adduserä½œæˆã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒã‚ã‚‹ã®ã§ã€å°‘ã—ã¿ã¦ã¿ã¾ã™ã€‚

1. `--disabled-password`
ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã®ã§ã€èª°ã‚‚ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªãƒªã¾ã™ã€‚

1. `--gecos ""`
ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„é›»è©±ç•ªå·ãªã©ã®æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚ˆã†ã§ã€ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç©ºæ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¦ã€ä¸è¦ãªæƒ…å ±ã‚’æ®‹ã—ã¦ã„ãªã„ã§ã™ã€‚

1. `--home "/nonexistent"`
æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ãªã„ã¨ã„ã†æ„å‘³ã§ã€ä¸‡ãŒä¸€ã€ä¸æ­£ã«ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¦ã‚‚ã€ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚

1. `--shell "/sbin/nologin"`
ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã§ããªããªã‚‹ãŸã‚ã€å®Ÿè³ªãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚

1. `--no-create-home`
ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œãªããªã‚Šã¾ã™ã€‚ã“ã‚Œã§ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ã‚’ä½œã‚Œã¾ã™ã€‚

1. `--uid "${UID}"`
åˆå›UID1000ä»¥å¤–ã‚’è¨­å®šã—ã¾ã™ã€‚

ã‹ãªã‚Šå¼·å›ºãªè¨­å®šã«è¦‹ãˆã¾ã™ã­ã€‚æµçŸ³ã¨æ€ã„ã¾ã™ã€‚

### compose.yaml

```yaml:compose.yaml
services:
  server:
    build:
      context: .
      target: final
    ports:
      - 8080:8080
```
ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­å®šã§ã™ã­ã€‚ç‰¹ã«è£œè¶³ã¯ãªã•ãã†ã§ã™ã€‚

## actix-webã®ã‚µãƒ³ãƒ—ãƒ«ä½œæˆ

ç·¨é›†ç®‡æ‰€ã¯[ã“ã¡ã‚‰](https://github.com/fruscianteee/docker_watch_demo_with_rust/commit/1bc86649f5f67c11df9af44edff11a99b27e65f5)ã§ã™ã€‚

ã‚·ãƒ³ãƒ—ãƒ«ã«ã—ãŸã„ã®ã¨ã€actix-webã«èˆˆå‘³æŒã£ã¦æ¬²ã—ã„ã®ã§ã€actix-webã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æœ€åˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½¿ã„ã¾ã—ãŸã€‚
@[card](https://actix.rs/docs/getting-started)

ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§`cargo run`ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§apiã‚µãƒ¼ãƒãŒèµ·å‹•ã—ã¾ã™ã€‚

```bash
curl -i localhost:8080
curl -i localhost:8080/hey
```
ãªã©ã‚’ã™ã‚‹ã¨å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚
ã‚·ãƒ³ãƒ—ãƒ«ã§ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã®ã§ã€actix-webã«èˆˆå‘³ã‚’æŒã£ã¦ã‚‚ã‚‰ãˆã‚Œã°å¹¸ã„ã§ã™ã€‚

## dockerå‘ã‘ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿®æ­£

```diff rust:src/main.rs
-    .bind(("127.0.0.1", 8080))?
+    .bind(("0.0.0.0", 8080))?
```

## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã‚’å°å…¥

askamaã¨ã„ã†jinja2ãƒ©ã‚¤ã‚¯ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ãŒã‚ã‚Šã€ãã‚Œã‚’å…¥ã‚Œã¾ã—ãŸã€‚
jinjaçµŒé¨“è€…ã§ã‚ã‚Œã°ã€ã™ã‚“ãªã‚Šç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãŠæ°—ã«å…¥ã‚Šãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ã€æ§‹é€ ä½“ã¨htmlãƒ•ã‚¡ã‚¤ãƒ«ã®ç´ä»˜ã‘ã‚‹ã‚ˆã†ãªæ›¸ãæ–¹ã§ã‚ã‚‹ã¨ã“ã‚ã§ã™ã€‚
æ¯”è¼ƒçš„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå¤§ãããªã£ãŸã¨ã—ã¦ã‚‚ã€`index.html`ã¨ãƒ•ã‚¡ã‚¤ãƒ«åæ¤œç´¢ã™ã‚‹ã“ã¨ã§ã™ãã«æ§‹é€ ä½“ãŒè¦‹ã¤ã‹ã‚‹ã®ãŒéå¸¸ã«ä¾¿åˆ©ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ç·¨é›†ç®‡æ‰€ã¯[ã“ã¡ã‚‰](https://github.com/fruscianteee/docker_watch_demo_with_rust/commit/d605079546ba8312990b5ac32140fd1a35ad2d18)ã§ã™ã€‚


è©¦ã—ã«ã€ã“ã®æ™‚ç‚¹ã§`cargo run`ã§å®Ÿè¡Œã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§`localhost:8080`ã‚’é–‹ã„ã¦ã¿ã¾ã™ã€‚

actix-webã¨askamaã®çµ„ã¿åˆã‚ã›ã‚’è¦‹ã¦ã¿ã¦ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
ãŠã¾ã‘ã¨ã—ã¦ã€webãƒšãƒ¼ã‚¸ã«htmxã‚’ä½¿ã£ãŸãƒœã‚¿ãƒ³ã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚
jsæ›¸ã‹ãšã«ajaxé€šä¿¡ã§ãã‚‹ã®ã§ä¾¿åˆ©ã§ã™ï¼

## docker compose watchã®è¨­å®š

ãŠå¾…ãŸã›ã—ã¾ã—ãŸã€‚ã“ã“ã§ã‚„ã£ã¨æœ¬é¡Œã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã¾ã§è›‡è¶³ã«çªãåˆã‚ã›ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€è¨­å®šã¯ã‹ãªã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ã§ã—ãŸã€‚

ã¾ãšã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ç”¨ã«htmlãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ ã—ãŸã®ã§Dockerfileã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff dockerfile:Dockerfile
RUN --mount=type=bind,source=src,target=src \
+    --mount=type=bind,source=templates,target=templates \
    --mount=type=bind,source=Cargo.toml,target=Cargo.toml \
```

æ¬¡ã«ãƒ¡ã‚¤ãƒ³ã§ã™ãŒã€6è¡Œã‚’è¿½åŠ ã ã‘ã«ãªã‚Šã¾ã™ã€‚

```diff yaml:compose.yaml
services:
  server:
    build:
      context: .
      target: final
    ports:
      - 8080:8080
+   develop:
+     watch:
+       - action: rebuild
+         path: ./src
+       - action: rebuild
+         path: ./templates
```

å†…å®¹ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€pathã§æŒ‡å®šã—ãŸ`./src`ã¾ãŸã¯`./templates`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹ã¨ã€actionãŒè¡Œã‚ã‚Œã¾ã™ã€‚
actionã®`rebuild`ã¯å­—ã®å¦‚ãã€ãƒ“ãƒ«ãƒ‰ã—ãªãŠã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã«é…ç½®ã—ã¾ã™ã€‚

actionã«ã¯rebuildã®ä»–ã«syncãŒã‚ã‚Šã¾ã™ã€‚
syncã¯
```yaml
    - action: sync
        path: ./web
        target: /src/web
```
ã®ã‚ˆã†ã«æ›¸ãã¾ã™ãŒã€æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠã®targetã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚
reactãªã©ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã§ã‚ã‚Œã°ã€ã‹ãªã‚Šä¾¿åˆ©ã‹ã¨æ€ã„ã¾ã™ãŒã€
ä»Šå›ã®rustã§ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã‚ã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«index.htmlã”ã¨ã®ãƒã‚¤ãƒŠãƒªã«å«ã¾ã‚Œã‚‹ã‚ˆã†ãªå½¢ã«ãªã‚Šã¾ã™ã€‚
ã‚ˆã£ã¦ã€ä»Šå›ã®æ§‹æˆã§ã¯syncãŒä½¿ãˆãªã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã§ã¯ã“ã®çŠ¶æ…‹ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ã¾ã™

```
docker compose watch
```

ãã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§`localhost:8080`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚

## å‹•ä½œç¢ºèª
watchãŒèµ·å‹•ã—ã¦ã„ã‚‹æœ€ä¸­ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
rebuildãŒèµ°ã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¡¨ç¤ºã‚„rustå´ã®å¤‰æ›´ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

# ã¾ã¨ã‚
ã„ã‹ãŒã ã£ãŸã§ã—ã‚‡ã†ã‹ã€‚
rusté–‹ç™ºã§`docker compose watch`ã‚’ä½¿ã†å ´åˆã¯ã€åŸºæœ¬rebuildã«ã™ã‚Œã°è‰¯ã•ãã†ã§ã™ã€‚
cargo watchã§ã„ã„ã˜ã‚ƒã‚“ã¨æ€ã‚ã‚Œã¾ã™ãŒã€ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§cargo watchã—ã¦ã„ã‚‹ã‚ˆã†ãªã‚‚ã®ã§ã™ã®ã§ã€æŒ™å‹•ã¯ä¼¼ã¦ã„ã¾ã™ãŒã€ç’°å¢ƒå·®åˆ†ã¯ãªããªã‚‹ã¨ã„ã£ãŸãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸä»Šå›ã¯rustã®ã¿ã®é–‹ç™ºã‚’æƒ³å®šã—ã¦ã„ã¾ã™ãŒã€
DBã‚µãƒ¼ãƒã‚’è¿½åŠ ã—ãŸã‚Šã™ã‚‹ã¨è©±ãŒå¤‰ã‚ã£ã¦ãã‚‹ã®ã§ã€`docker compose watch`ã®æ©æµã‚’å—ã‘ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

`docker compose watch`ã®å¯èƒ½æ€§ã‚’çŸ¥ã‚Šã¤ã¤ã€rustã®é­…åŠ›ã‚‚ä¼ã‚ã‚Œã°ã¨æ€ã„ã¾ã™ï¼

ã“ã®è¨˜äº‹ãŒå½¹ã«ç«‹ã¦ã‚Œã°å¹¸ã„ã§ã™ï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ï¼
